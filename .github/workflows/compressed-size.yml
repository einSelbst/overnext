# https://docs.github.com/en/free-pro-team@latest/actions/reference/events-that-trigger-workflows#configuring-workflow-events
name: Audits

on:
  pull_request:
    types: [ready_for_review]

jobs:
  Compressed-Size:
    name: Compare compressed file sizes
    runs-on: ubuntu-latest

    steps:
      - name: Check for changes
        id: skip_check
        uses: fkirc/skip-duplicate-actions@master
        with:
          cancel_others: 'false'
          paths: '["src/**"]'

      - name: Check out the application's source code
        if: ${{ steps.skip_check.outputs.should_skip != 'true' }}
        uses: actions/checkout@v2-beta
        with:
          fetch-depth: 1

      - uses: actions/cache@v2
        if: ${{ steps.skip_check.outputs.should_skip != 'true' }}
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Check and report changes in the application's package size
        if: ${{ steps.skip_check.outputs.should_skip != 'true' }}
        uses: preactjs/compressed-size-action@v2
        with:
          repo-token: '${{ secrets.GITHUB_TOKEN }}'
          build-script: 'build'
          # Any JS files anywhere within a dist directory:
          # pattern: ".next/static/**/*.js"
          pattern: '.next/**/*.{css,js,json,html}'
          # pattern: "{build/**/*.js,build/**/*.css}" # multiple paths
          # compression: none
          # show-total: false
          # compression: brotli
          # Always ignore SourceMaps and node_modules:
          # exclude: "{**/*.map,**/cache/**}"
          exclude: '**/cache/**'
          strip-hash: "[\\/\\.-]([\\w-]{20,21})[\\.\\/]"
          # Ignore changes of less than 100 bytes
          minimum-change-threshold: 100

      - name: Bundle Size
        if: ${{ steps.skip_check.outputs.should_skip != 'true' }}
        uses: andresz1/size-limit-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          skip_step: build
        env:
          CI_JOB_NUMBER: 1
